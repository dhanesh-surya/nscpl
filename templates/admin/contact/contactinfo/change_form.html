{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* Enhanced Map Settings Styling */
.fieldset-map_settings {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #007cba;
    border-radius: 12px;
    padding: 25px;
    margin: 15px 0;
    box-shadow: 0 4px 12px rgba(0, 124, 186, 0.1);
}

.fieldset-map_settings h2 {
    color: #007cba;
    border-bottom: 3px solid #007cba;
    padding-bottom: 15px;
    margin-bottom: 25px;
    font-size: 18px;
    font-weight: bold;
}

.field-map_address {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 15px;
}

.field-map_address label {
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    display: block;
}

.field-map_address input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.field-map_address input:focus {
    border-color: #007cba;
    box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
    outline: none;
}

.field-latitude, .field-longitude {
    display: inline-block;
    width: 48%;
    margin-right: 2%;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.field-latitude label, .field-longitude label {
    font-size: 12px;
    color: #666;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.field-latitude input, .field-longitude input {
    background: transparent;
    border: none;
    font-family: monospace;
    font-size: 13px;
    color: #495057;
    width: 100%;
}

.map-address-helper {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    font-size: 14px;
    color: #1565c0;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
}

.map-address-helper strong {
    color: #0d47a1;
    font-weight: bold;
}

.geocoding-button {
    background: linear-gradient(135deg, #007cba 0%, #0056b3 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px 0;
    box-shadow: 0 2px 8px rgba(0, 124, 186, 0.3);
}

.geocoding-button:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 124, 186, 0.4);
}

.geocoding-status {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: bold;
    margin: 10px 0;
    transition: all 0.3s ease;
}

.geocoding-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.geocoding-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.geocoding-status.loading {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.map-preview {
    margin-top: 20px;
    border: 2px solid #ddd;
    border-radius: 12px;
    overflow: hidden;
    background: #f8f9fa;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.map-preview-header {
    background: #007cba;
    color: white;
    padding: 12px 20px;
    font-weight: bold;
    font-size: 14px;
}

.map-preview iframe {
    width: 100%;
    height: 250px;
    border: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    .field-latitude, .field-longitude {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
    }
    
    .fieldset-map_settings {
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced map address functionality
    const mapAddressField = document.querySelector('#id_map_address');
    const latitudeField = document.querySelector('#id_latitude');
    const longitudeField = document.querySelector('#id_longitude');
    
    if (mapAddressField && latitudeField && longitudeField) {
        // Add enhanced helper text
        addEnhancedMapAddressHelper();
        
        // Add geocoding button
        addGeocodingButton();
        
        // Add map preview
        addMapPreview();
        
        // Add keyboard shortcuts
        addKeyboardShortcuts();
    }
});

function addEnhancedMapAddressHelper() {
    const mapEmbedField = document.querySelector('#id_map_embed_code');
    const mapAddressField = document.querySelector('#id_map_address');
    
    if (mapEmbedField) {
        const embedHelper = document.createElement('div');
        embedHelper.className = 'map-address-helper';
        embedHelper.innerHTML = `
            <strong>üó∫Ô∏è Google Maps Embed Code:</strong><br>
            ‚Ä¢ Go to <a href="https://maps.google.com" target="_blank">Google Maps</a> and search for your location<br>
            ‚Ä¢ Click "Share" ‚Üí "Embed a map" ‚Üí Copy the iframe code<br>
            ‚Ä¢ Paste the complete iframe code in the field above<br>
            ‚Ä¢ <strong>Example:</strong> &lt;iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d29626.64408062467!2d82.40677533954715!3d21.844783605426276!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3a27cf07e471c5a9%3A0x36fff97d86a9b29f!2sMahamaya%20Mandir!5e0!3m2!1sen!2sin!4v1760684601523!5m2!1sen!2sin" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"&gt;&lt;/iframe&gt;
        `;
        mapEmbedField.parentNode.insertBefore(embedHelper, mapEmbedField.nextSibling);
    }
    
    if (mapAddressField) {
        const addressHelper = document.createElement('div');
        addressHelper.className = 'map-address-helper';
        addressHelper.innerHTML = `
            <strong>üìç Alternative - Address Field:</strong><br>
            ‚Ä¢ Enter a complete address including street, city, state/province, and country<br>
            ‚Ä¢ Example: "123 Main Street, Mumbai, Maharashtra, India"<br>
            ‚Ä¢ Coordinates will be automatically generated when you save
        `;
        mapAddressField.parentNode.insertBefore(addressHelper, mapAddressField.nextSibling);
    }
}

function addGeocodingButton() {
    const mapAddressField = document.querySelector('#id_map_address');
    if (!mapAddressField) return;
    
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'geocoding-button';
    button.innerHTML = 'üåç Get Coordinates from Address';
    button.style.marginTop = '10px';
    
    button.addEventListener('click', function() {
        const address = mapAddressField.value.trim();
        if (!address) {
            alert('Please enter an address first.');
            return;
        }
        
        showGeocodingStatus('Getting coordinates...', 'loading');
        
        // Simulate geocoding (in real implementation, this would call your Django view)
        setTimeout(() => {
            showGeocodingStatus('Coordinates will be generated when you save the form.', 'success');
        }, 1500);
    });
    
    mapAddressField.parentNode.appendChild(button);
}

function addMapPreview() {
    const mapAddressField = document.querySelector('#id_map_address');
    const latitudeField = document.querySelector('#id_latitude');
    const longitudeField = document.querySelector('#id_longitude');
    
    if (!mapAddressField || !latitudeField || !longitudeField) return;
    
    const previewDiv = document.createElement('div');
    previewDiv.className = 'map-preview';
    previewDiv.style.display = 'none';
    previewDiv.innerHTML = `
        <div class="map-preview-header">
            üìç Map Preview
        </div>
        <div id="map-preview-container"></div>
    `;
    
    mapAddressField.parentNode.appendChild(previewDiv);
    
    function updateMapPreview() {
        const lat = latitudeField.value;
        const lng = longitudeField.value;
        
        if (lat && lng) {
            previewDiv.style.display = 'block';
            const container = document.getElementById('map-preview-container');
            if (container) {
                container.innerHTML = `
                    <iframe 
                        src="https://www.google.com/maps/embed/v1/view?key={{ GOOGLE_MAPS_API_KEY }}&center=${lat},${lng}&zoom=15&maptype=roadmap"
                        width="100%" 
                        height="250" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy">
                    </iframe>
                `;
            }
        } else {
            previewDiv.style.display = 'none';
        }
    }
    
    latitudeField.addEventListener('input', updateMapPreview);
    longitudeField.addEventListener('input', updateMapPreview);
    updateMapPreview();
}

function addKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'g') {
            e.preventDefault();
            const mapAddressField = document.querySelector('#id_map_address');
            if (mapAddressField && mapAddressField.value.trim()) {
                const button = document.querySelector('.geocoding-button');
                if (button) button.click();
            }
        }
    });
}

function showGeocodingStatus(message, type) {
    // Remove existing status
    const existingStatus = document.querySelector('.geocoding-status');
    if (existingStatus) {
        existingStatus.remove();
    }
    
    const status = document.createElement('div');
    status.className = `geocoding-status ${type}`;
    status.textContent = message;
    
    const mapAddressField = document.querySelector('#id_map_address');
    mapAddressField.parentNode.appendChild(status);
    
    if (type === 'success') {
        setTimeout(() => {
            status.remove();
        }, 5000);
    }
}
</script>
{% endblock %}
